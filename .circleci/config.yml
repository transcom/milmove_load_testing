############
#
# Caches
#
# Caches may have a `v1-` prefix, since caches in CircleCI 2.0 are immutable.
# A prefix provides an easy way to invalidate a cache.  See https://circleci.com/docs/2.0/caching/#clearing-cache
#
############

version: "2.1"

executors:
  primary:
    resource_class: small
    docker:
      - image: cimg/python:3.9.6
    environment:
      PIPENV_VENV_IN_PROJECT: true

jobs:

  # `test` is used to run pre-commit hooks on all files
  test:
    executor: primary
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-pre-commit-dot-cache-{{ checksum ".pre-commit-config.yaml" }}
      - restore_cache:  # ensure this step occurs *before* installing dependencies
          key: v1-pipenv-{{ checksum "Pipfile.lock" }}
      - restore_cache:
          key: v1-local-bin-{{ checksum "Brewfile.local" }}
      - run:
          name: install shellcheck if needed
          command: |
            [ -x ~/.local/bin/shellcheck ] ||
            (sudo apt-get update -y &&
            sudo apt-get install -y shellcheck &&
            mkdir -p ~/.local/bin &&
            cp /usr/bin/shellcheck ~/.local/bin)
      - run:
          name: install dependencies
          command: |  # use pipenv to install dependencies
            pipenv sync -d
      - run: pipenv run pre-commit install --install-hooks
      - run:
          name: Run pre-commit tests
          command: pipenv run pre-commit run --all-files
      - run:
          name: run tests
          command: |
            pipenv run pytest --ignore=openapi_client --junit-xml=junit/report.xml --cov-report html:coverage_html --cov=utils --cov=tasks
      - store_test_results:
          path: ~/project/junit/report.xml
      - store_artifacts:
          path: ~/project/coverage_html
          destination: coverage_html
      - save_cache:
          key: v1-pre-commit-dot-cache-{{ checksum ".pre-commit-config.yaml" }}
          paths:
            - ~/.cache/pre-commit
      - save_cache:
          key: v1-pipenv-{{ checksum "Pipfile.lock" }}
          paths:
            - ".venv"
      - save_cache:
          key: v1-local-bin-{{ checksum "Brewfile.local" }}
          paths:
            - ~/.local/bin

  # `build` confirms a docker build works
  build:
    executor: primary
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: false
      - run:
          name: docker build
          command: |
            docker build -t milmove_load_testing:local .
workflows:
  version: 2

  main:
    jobs:
      - test
      - build
